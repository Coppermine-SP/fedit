## IV. 기능 설계
### A. 기능 개요
프로그램의 진입점인 `main()`은 모듈의 초기화 과정을 마치고 `ui_input_loop()`을 대기하게 되는데, 이 함수의 이벤트 콜백 함수는 `input_event()`이다. 이 함수에서 키 조합에 따른 기능 호출이나 텍스트 입력을 처리하게 된다. 조합 키 기능의 경우(저장, 종료, 탐색) 해당 기능 함수의 반환 값에 따라 `input_event()`의 반환 값이 결정된다. 

#

### B. 커서 관리와 위치 체계
커서 관리에서 가장 중요한 것은 터미널 사이즈가 변화하여도 커서가 현재 문자 위치에서 유지되어야 하며, 텍스트 버퍼에서의 위치와 화면상의 커서의 위치가 동기화되어야 하는 것이다. 텍스트의 EOL은 LF를 사용하고, CRLF는 고려하지 않는다.
			
이러한 설계 목표를 달성하기 위해 아래의 위치 개념을 사용한다:
-  **기준 위치 (Base Position)**
  기준 위치는 화면에 그려지는 텍스트의 첫 번째 문자의 배열 상 위치를 나타낸다.
-  **상대 위치 (Relative Position)**
  상대 위치는 기준 위치로부터 얼마나 떨어져있는지 나타내는 값이다.
- **절대 위치 (Absolute Position)**
  절대 위치는 텍스트 버퍼에서의 현재 커서의 절대적인 위치이다.
abs_pos = base_pos + rel_pos 의 관계로 구한다.
-  **스크린 위치 (Screen Position)**
  스크린 위치는 상대 위치를 기준으로 실제 화면에서의 커서 위치를 계산한 값이다. 현재 상대 위치에서 상대 위치 0까지 텍스트 버퍼를 읽어 LF 문자가 있을 경우, 해당 문자의 행에서 남은 열 수만큼 더한다.

커서를 표시하기 위해, 현재 상대 위치로부터 스크린 위치를 구하고 이를 다음 식을 통해 X, Y 좌표로 변환하여 화면에 표시한다: 

`x_pos = (screen_pos % cols), y_pos = (screen_pos / cols)`

</br>
<p align="center">
<img src="https://github.com/user-attachments/assets/8bad7387-0274-49ec-82f3-fe60a1764ad7" style="width:60%">
<p align="center">Figure IV: 위치 시스템의 동작 시각화</p>
</br>

터미널 크기가 변화하면 `ui_input_loop()`에서 이를 감지하고, `ui_init()`에서 전달한 리사이즈 이벤트 콜백 함수를 실행한다. 이 콜백 함수는 현재 상대 위치에서의 스크린 위치를 다시 계산하여 화면에 그린다. 만약 터미널 사이즈가 감소하여 커서가 현재 화면에 표시할 수 없는 스크린 위치인 경우에는 상대 위치를 0으로 조정한다.

#

### C. 편집 영역 및 커서 그리기
`editor_draw()` 함수는 `te_get_buffer()` 함수로 텍스트 버퍼를 받아 `ui_draw_text()` 함수에 전달해 에디터 영역을 그리고, 계산 된 현재 행과 총 행, 파일 이름을 `ui_set_status()` 함수에 전달하여 상태 바를 그린다. 또한 현재 상대 위치의 스크린 위치를 계산하여 `ui_cursor_move()` 함수를 통해 화면에 커서를 그린다.
커서 이동이나 텍스트 수정과 같은 동작을 수행하고 난 후에는 `editor_draw()` 함수를 호출하여 커서를 다시 그리고, 기준 위치가 변경되었을 경우에는 편집 영역을 다시 그린다.

#

### D. 커서 이동
텍스트 기준 행은 텍스트에서 `LF(‘\n’)`을 기준으로 한 행을 의미하고, 스크린 기준 행은 화면에 표시되는 한 행 (80x24 크기의 터미널의 경우에 한 행은 80 문자)를 의미한다. 최대 스크린 위치 `((cols * (rows-2))-1)` 는 스크린에서 상태 표시줄을 제외한 편집 영역에서 사용 할 수 있는 공백 문자를 포함한 최대 문자 수이다.

각 커서 이동 키의 간략한 이동 방식은 다음과 같다:
-  **위쪽 방향 키**

    현재 행에서 상위 행의 첫 번째 열로 상대 위치를 이동한다. 만약 상대 위치가 0이라면, 텍스트 기준으로 1개 행만큼 기준 위치를 올린다.
-  **아래쪽 방향 키**
  
    현재 행에서 하위 행의 첫 번째 열로 상대 위치를 이동한다. 만약 다음 행의 상대 위치가 최대 스크린 위치를 벗어난다면, 텍스트 기준으로 1개 행 만큼 기준 위치를 내린다.
-  **왼쪽 방향 키**
  
    현재 행에서 왼쪽 열로 이동(상대 위치 감소)한다. 만약 다음 열의 상대 위치가 최대 스크린 위치를 벗어난다면, 스크린 기준으로 1개 행만큼 기준 위치를 올린다.
- **오른쪽 방향 키**
  
    현재 행에서 오른쪽 열로 이동(상대 위치 증가)한다. 만약 다음 열의 상대 위치가 최대 스크린 위치를 벗어난다면, 스크린 기준으로 1개 행만큼 기준 위치를 내린다.
- **Home**
  
    현재 행의 첫번째 열로 이동한다. 만약 해당 열의 상대 위치가 최대 스크린 위치를 벗어난다면, 적절하게 기준 위치를 조정한다.
- **End**

    현재 행의 마지막 열로 이동한다. 만약 해당 열의 상대 위치가 최대 스크린 위치를 벗어난다면, 적절하게 기준 위치를 조정한다.
-	**PgUp**
  
    최대 스크린 위치만큼 텍스트 기준 행으로 기준 위치를 올리고 상대 위치를 0으로 한다.
-	**PgDown**

    최대 스크린 위치만큼 텍스트 기준 행으로 기준 위치를 내리고 상대 위치를 0으로 한다.

이러한 커서 이동 키 동작으로 인해 절대 좌표가 변경되는 경우에는 `te_set_cursor()` 함수로 te 모듈에 이를 통지한다. 

# 

### E. 텍스트 수정
`input_event()` 함수에서 문자 키나 엔터 키를 받았을 경우에 `te_insert()` 함수에 현재 커서의 절대 위치와 문자 값(엔터 키의 경우 LF)을 전달하여 현재 위치에 문자를 삽입하고 상대 위치를 1 증가시킨다. 

백 스페이스 키를 받았을 경우에는 `te_delete()` 함수에 현재 절대 위치를 전달하여 현재 커서 위치의 이전 문자를 지우고 상대 위치를 1 감소시킨다. 만약 상대 위치가 음수거나, 스크린 위치가 최대 스크린 위치를 초과한 경우에는 기준 위치와 상대 위치를 다시 스크린 기준 행으로 올리거나 내려 적절하게 조정한다.

#

### F. 탐색
탐색 기능은 `input_event()`에서 CTRL-F 키 조합을 받았을 때, `find_function()`을 호출한다. 이 함수는 먼저 사용자에게 찾을 문자열을 입력 받는 프롬프트를 표시한다. 입력 받은 문자열을 Rabin-Karp 알고리즘을 사용하여 해시 값을 비교하여 찾는다. 비교는 행 단위로 수행하며 일치한 문자열 패턴을 발견한다면 해당 행의 시작 위치와, 행에서의 상대적인 패턴 시작 및 끝 위치를 구조체화하여 이중 연결 리스트에 저장한다.

탐색이 완료되면 사용자가 왼쪽, 오른쪽 화살표 키로 리스트에서 항목을 선택할 수 있도록 한다. 편집 영역에서의 표시는 임시 스크린 버퍼를 만들고 현재 선택된 항목의 행 시작 위치에서 최대 스크린 위치만큼 텍스트 버퍼에서 복사한다. 그리고 패턴 시작 및 끝 위치에 적절한 ANSI 이스케이프 시퀀스를 삽입하고 임시 스크린 버퍼를 출력하여 문자열 패턴이 반전색으로 표시되도록 한다.

ESC 키를 누르면 스크린 버퍼가 복구되고 기준 위치와 상대 위치를 복원하여 커서가 원래 위치로 이동하도록 하고 기능을 종료한다.  Enter 키를 누르면 스크린 버퍼가 복구되고 현재 선택된 항목의 행의 시작 위치가 기준 위치가 된다. 또한 선택한 항목의 패턴 시작 위치를 상대 위치로 하여 커서가 문자열 패턴의 시작 위치로 이동하도록 하고 기능을 종료한다. 만약 탐색 결과가 없다면 “Pattern not found” 메세지를 출력하고 기능을 종료한다.

#

### G. 저장
저장 기능은 `input_event()`에서 CTRL-S 키 조합을 받았을 때, `save_function()`을 호출한다. 이 함수는 만약 명령 인수가 빈 상태로 시작하여 파일 이름이 존재하지 않는다면, 파일 이름을 받는 프롬프트를 표시한다. 파일 이름을 `te_buffer_save()`에 전달하여 텍스트 버퍼를 파일에 저장하고, 저장된 파일 이름과 라인 수와 파일 크기를 메세지로 출력한다.

만약 마지막 저장 이후 아무런 변경 사항이 없다면, “There is no local changes to save.” 메세지를 출력하고 기능이 종료된다.

#

### H. 종료
종료 기능은 `input_event()`에서 CTRL-Q 키 조합을 받았을 때,  `quit_function()`을 호출한다. 이 함수는 현재 버퍼가 저장되었다면 즉시 종료하고, 변경 사항이 있지만 저장되지 않은 상태라면 “No write since last change (Press Ctrl-Q again to override)” 메세지를 출력하고 Ctrl-Q 키 조합을 한번 더 눌러야 종료할 수 있도록 한다.

